<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Single-file Todo PWA</title>

  <meta name="theme-color" content="#0ea5a4">

  <style>
    :root{
      --bg:#0f172a;
      --card:#0b1220;
      --muted:#94a3b8;
      --accent:#0ea5a4;
      --glass: rgba(255,255,255,0.03);
      color-scheme: dark;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body,#app{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg,#071027 0%, #08111a 60%), var(--bg);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .container{
      width:100%;
      max-width:760px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:16px;
      padding:18px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:12px;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:52px;height:52px;border-radius:10px;
      display:grid;place-items:center;
      background:linear-gradient(135deg,var(--accent),#0284c7);
      font-weight:700;
      font-size:20px;
      color:#032;
      box-shadow:0 6px 18px rgba(14,165,164,0.12), inset 0 -6px 18px rgba(255,255,255,0.03);
    }
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    button{
      background:var(--glass);
      border:1px solid rgba(255,255,255,0.04);
      padding:8px 12px;border-radius:10px;color:inherit;font-weight:600;
      cursor:pointer;
    }
    button.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.03)}
    .new-todo{
      display:flex;
      gap:8px;
      margin-bottom:12px;
    }
    input[type="text"]{
      flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
      background:rgba(255,255,255,0.02);color:inherit;font-size:15px;
      outline:none;
    }
    ul.todos{list-style:none;margin:0;padding:0;display:grid;gap:8px}
    li.todo{
      display:flex;align-items:center;gap:10px;padding:12px;border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
      border:1px solid rgba(255,255,255,0.02);
    }
    .todo .title{flex:1;word-break:break-word}
    .todo.done .title{opacity:0.6;text-decoration:line-through}
    .todo small{display:block;color:var(--muted);font-size:12px}
    .actions{display:flex;gap:6px}
    .empty{padding:18px;border-radius:12px;background:rgba(255,255,255,0.01);text-align:center;color:var(--muted)}
    footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted);font-size:13px}
    .filter{display:flex;gap:6px}
    .filter button{padding:6px 10px;border-radius:8px;font-weight:600}
    input[type="checkbox"]{width:18px;height:18px}
    @media (max-width:560px){
      .brand p.lead{display:none}
    }
    /* focus styles */
    button:focus,input:focus{box-shadow:0 0 0 3px rgba(14,165,164,0.12);outline:none}
  </style>
</head>
<body>
  <div class="container" id="app" role="application" aria-label="Todo app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">TD</div>
        <div>
          <h1>Single-file Todo PWA</h1>
          <p class="lead">Offline-capable, installable, and all-in-one single file.</p>
        </div>
      </div>
      <div class="controls">
        <button id="installBtn" class="ghost" hidden aria-hidden="true">Install</button>
        <button id="clearAll" title="Clear all completed">Clear completed</button>
      </div>
    </header>

    <div class="new-todo" role="region" aria-label="Add todo">
      <input id="todoInput" type="text" placeholder="Add a todo and press Enter..." aria-label="New todo">
      <button id="addBtn" aria-label="Add todo">Add</button>
    </div>

    <main>
      <ul class="todos" id="todoList" aria-live="polite"></ul>
      <div id="emptyState" class="empty" hidden>No todos yet ‚Äî add your first one!</div>
    </main>

    <footer>
      <div class="filter" role="tablist" aria-label="Filter todos">
        <button data-filter="all" class="filter-btn" aria-pressed="true">All</button>
        <button data-filter="active" class="filter-btn" aria-pressed="false">Active</button>
        <button data-filter="completed" class="filter-btn" aria-pressed="false">Completed</button>
      </div>
      <div id="count" aria-live="polite">0 items</div>
    </footer>
  </div>

  <script>
  (function(){
    // -----------------------------
    // App state + utilities
    // -----------------------------
    const STORAGE_KEY = 'sf-todo-pwa:v1';
    let state = {
      todos: [],
      filter: 'all'
    };

    // load state from localStorage
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw) state = JSON.parse(raw);
      }catch(e){ console.warn('Failed to load state', e) }
    }
    function save(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch(e){ console.warn('Failed to save state', e) }
    }
    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8) }

    // -----------------------------
    // UI rendering & events
    // -----------------------------
    const todoList = document.getElementById('todoList');
    const todoInput = document.getElementById('todoInput');
    const addBtn = document.getElementById('addBtn');
    const emptyState = document.getElementById('emptyState');
    const countEl = document.getElementById('count');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const clearAllBtn = document.getElementById('clearAll');
    const installBtn = document.getElementById('installBtn');

    function render(){
      // filtered todos
      const todos = state.todos.filter(t=>{
        if(state.filter === 'active') return !t.done;
        if(state.filter === 'completed') return t.done;
        return true;
      });

      todoList.innerHTML = '';
      if(todos.length === 0){
        emptyState.hidden = false;
      } else {
        emptyState.hidden = true;
        todos.forEach(t => {
          const li = document.createElement('li');
          li.className = 'todo' + (t.done ? ' done' : '');
          li.setAttribute('data-id', t.id);

          li.innerHTML = \`
            <input aria-label="Toggle todo" type="checkbox" \${t.done ? 'checked' : ''}>
            <div class="title">
              <div contenteditable="true" role="textbox" aria-label="Edit todo">\${escapeHtml(t.text)}</div>
              <small>\${new Date(t.idNumeric).toLocaleString()}</small>
            </div>
            <div class="actions">
              <button class="btn-edit" title="Edit">‚úèÔ∏è</button>
              <button class="btn-delete" title="Delete">üóëÔ∏è</button>
            </div>
          \`;

          // events
          const checkbox = li.querySelector('input[type="checkbox"]');
          checkbox.addEventListener('change', () => {
            toggleTodo(t.id);
          });

          const del = li.querySelector('.btn-delete');
          del.addEventListener('click', () => {
            removeTodo(t.id);
          });

          const editable = li.querySelector('.title [contenteditable]');
          editable.addEventListener('input', () => {
            // lightweight live-edit saving
            updateTodoText(t.id, editable.innerText.trim());
          });

          // ensure editable loses formatting on paste
          editable.addEventListener('paste', (ev)=>{
            ev.preventDefault();
            const text = (ev.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
          });

          todoList.appendChild(li);
        });
      }

      const activeCount = state.todos.filter(t=>!t.done).length;
      countEl.textContent = \`\${activeCount} item\${activeCount !== 1 ? 's' : ''}\`;

      // update filter buttons aria-pressed
      filterBtns.forEach(b=>{
        const f = b.dataset.filter;
        b.setAttribute('aria-pressed', f === state.filter ? 'true' : 'false');
      });

      save();
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

    // actions
    function addTodo(text){
      if(!text || !text.trim()) return;
      const item = {
        id: uid(),
        idNumeric: Date.now(),
        text: text.trim(),
        done: false
      };
      state.todos.unshift(item);
      render();
    }
    function toggleTodo(id){
      state.todos = state.todos.map(t => t.id === id ? {...t, done: !t.done} : t);
      render();
    }
    function removeTodo(id){
      state.todos = state.todos.filter(t => t.id !== id);
      render();
    }
    function updateTodoText(id, text){
      state.todos = state.todos.map(t => t.id === id ? {...t, text: text} : t);
      render();
    }
    function clearCompleted(){
      state.todos = state.todos.filter(t => !t.done);
      render();
    }

    // UI wiring
    addBtn.addEventListener('click', ()=>{ addTodo(todoInput.value); todoInput.value=''; todoInput.focus(); });
    todoInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ addTodo(todoInput.value); todoInput.value=''; }
    });

    filterBtns.forEach(b => {
      b.addEventListener('click', ()=>{
        state.filter = b.dataset.filter;
        render();
      });
    });

    clearAllBtn.addEventListener('click', clearCompleted);

    // initial load
    load();
    render();

    // -----------------------------
    // Install prompt handling
    // -----------------------------
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent Chrome 67+ from automatically showing the prompt
      e.preventDefault();
      deferredPrompt = e;
      installBtn.hidden = false;
      installBtn.ariaHidden = false;
      installBtn.addEventListener('click', async function installHandler(){
        installBtn.disabled = true;
        try{
          await deferredPrompt.prompt();
          const choice = await deferredPrompt.userChoice;
          if(choice.outcome === 'accepted'){
            console.log('User accepted A2HS');
          } else {
            console.log('User dismissed A2HS');
            installBtn.hidden = false;
          }
        }catch(err){
          console.warn('Install failed', err);
        } finally {
          installBtn.disabled = false;
          deferredPrompt = null;
          installBtn.removeEventListener('click', installHandler);
          installBtn.hidden = true;
        }
      });
    });
    window.addEventListener('appinstalled', () => {
      console.log('PWA installed');
    });

    // -----------------------------
    // Inline manifest & service worker via Blob
    // -----------------------------
    // Create inline manifest blob; include an embedded SVG data URL icon.
    (function createInlineManifest(){
      const svgIcon = encodeURIComponent(\`
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
          <rect width="100%" height="100%" rx="64" ry="64" fill="#0ea5a4"/>
          <text x="50%" y="52%" font-size="180" text-anchor="middle" alignment-baseline="middle" font-family="Inter, Arial" fill="#022" font-weight="700">TD</text>
        </svg>\`.trim());
      const dataIcon = 'data:image/svg+xml;utf8,' + svgIcon;

      const manifest = {
        name: "Single-file Todo PWA",
        short_name: "TodoPWA",
        description: "A single-file vanilla JS todo app that behaves like a PWA (inline service worker + manifest).",
        start_url: ".",
        display: "standalone",
        background_color: "#071027",
        theme_color: "#0ea5a4",
        icons: [
          {
            src: dataIcon,
            sizes: "512x512",
            type: "image/svg+xml",
            purpose: "any maskable"
          }
        ]
      }
